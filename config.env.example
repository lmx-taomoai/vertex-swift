# Swift 训练配置文件
# 复制此文件为 config.env 并根据需要修改

# ========== Google Cloud 配置 ==========
PROJECT_ID="im-drawing-462011"
REGION="us-central1"
SERVICE_ACCOUNT="vertex-ai-training@im-drawing-462011.iam.gserviceaccount.com"

# ========== 镜像配置 ==========
IMAGE_REPO="custom-job-repo"
IMAGE_NAME="swift-trainer-qwen3vl"
IMAGE_TAG="latest"

# ========== 模型和数据路径 ==========
# 默认从 GCS 下载（推荐，速度快）
GCS_MODEL_PATH="gs://im-drawing-462011-models/models--Qwen--Qwen3-VL-4B-Instruct"

# 或者从 Hugging Face 直接下载（较慢）
# MODEL_PATH="Qwen/Qwen3-VL-4B-Instruct"

# GCS 输出路径（自动生成时间戳）
GCS_OUTPUT_PATH="gs://im-drawing-462011-outputs/swift-training/$(date +%Y%m%d-%H%M%S)"

# 输出目录（容器内）
OUTPUT_DIR="/app/output"

# 训练数据集
TRAIN_DATASET="view.jsonl"
TRAIN_DATASET_EX="view_ex.jsonl"

# ========== 机器配置 ==========
# 机器类型选项:
# - a2-highgpu-1g   (1x A100, 40GB VRAM) - 推荐用于中小模型
# - a2-highgpu-2g   (2x A100, 80GB VRAM) - 推荐用于大模型或大批次
# - a2-megagpu-16g  (16x A100, 640GB VRAM) - 超大规模训练
MACHINE_TYPE="a2-highgpu-1g"
REPLICA_COUNT=1
ACCELERATOR_TYPE="NVIDIA_TESLA_A100"
ACCELERATOR_COUNT=1

# ========== 训练超参数 ==========
# 训练轮数
NUM_EPOCHS=2

# 批次大小（每个设备）
BATCH_SIZE=1

# 学习率
LEARNING_RATE="1e-4"

# LoRA 配置
LORA_RANK=8
LORA_ALPHA=32

# 最大序列长度
MAX_LENGTH=3000

# 梯度累积步数
GRADIENT_ACCUMULATION_STEPS=2

# 评估和保存步数
EVAL_STEPS=100
SAVE_STEPS=100
SAVE_TOTAL_LIMIT=2
LOGGING_STEPS=5

# Warmup 比例
WARMUP_RATIO=0.05

# ========== Swift 特定配置 ==========
# Qwen-VL BBox 格式
QWENVL_BBOX_FORMAT="new"

# PyTorch CUDA 分配配置
PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# 图像最大 token 数
IMAGE_MAX_TOKEN_NUM=1280

# 视频最大 token 数
VIDEO_MAX_TOKEN_NUM=128

# FPS 最大帧数
FPS_MAX_FRAMES=16

# 每个节点的进程数（GPU 数量）
NPROC_PER_NODE=1

# ========== 高级选项 ==========
# 注意力实现（flash_attn 或 eager）
ATTN_IMPL="flash_attn"

# 数据类型（bfloat16, float16, float32）
TORCH_DTYPE="bfloat16"

# 是否冻结 ViT
FREEZE_VIT=false

# 是否冻结 Aligner
FREEZE_ALIGNER=false

# 是否启用 Packing
PACKING=true

# 是否启用梯度检查点
GRADIENT_CHECKPOINTING=true

# ViT 梯度检查点
VIT_GRADIENT_CHECKPOINTING=false

# Padding Free
PADDING_FREE=true

# 数据集分割比例（验证集）
SPLIT_DATASET_RATIO=0.01

# 数据加载器工作线程数
DATASET_NUM_PROC=4
DATALOADER_NUM_WORKERS=4

# DeepSpeed（当使用多GPU时自动启用）
DEEPSPEED_CONFIG="zero3"

# ========== 监控配置（可选） ==========
# Weights & Biases
# WANDB_API_KEY="your-wandb-api-key"
# WANDB_PROJECT="qwen3vl-training"
# WANDB_ENTITY="your-wandb-username"

# TensorBoard（默认启用）
# TENSORBOARD_DIR="$OUTPUT_DIR/tensorboard"

# ========== 调试选项 ==========
# 是否启用调试模式
DEBUG=false

# 是否保存详细日志
VERBOSE=true

# 是否跳过模型验证
SKIP_MODEL_VALIDATION=false

